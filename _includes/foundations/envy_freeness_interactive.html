<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envy-Freeness Interactive Demo</title>
    <style>
        :root {
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --border-light: #e5e7eb;
            --border-medium: #d1d5db;
            --light-blue: #eff6ff;
            --primary-blue: #3b82f6;
            --bg-white: #ffffff;
            --bg-light: #f9fafb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f9fafb;
        }

        .demo-section {
            background: linear-gradient(135deg, #f8fafc, #ffffff);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: var(--shadow-md);
            max-width: 1200px;
            margin: 0 auto;
        }

        h4 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-weight: 600;
            font-size: 1.5rem;
        }

        h5 {
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .demo-explanation {
            background: var(--light-blue);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            border-left: 3px solid var(--primary-blue);
        }

            .demo-explanation p {
                font-size: 0.9rem;
                color: var(--text-secondary);
                margin: 0;
            }

        .demo-controls {
            background: var(--bg-white);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-light);
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
        }

        .demo-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: var(--border-medium);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

            .demo-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: var(--primary-blue);
                cursor: pointer;
                box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
                transition: all 0.2s ease;
            }

                .demo-slider::-webkit-slider-thumb:hover {
                    transform: scale(1.1);
                }

        .demo-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-medium);
            border-radius: 6px;
            background: var(--bg-white);
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .value-display {
            font-weight: 600;
            color: var(--primary-blue);
            min-width: 60px;
            text-align: right;
            font-size: 0.9rem;
            font-family: 'Courier New', monospace;
        }

        .visualization-container {
            background: var(--bg-white);
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
            border: 1px solid var(--border-light);
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #envyVisualization {
            width: 100%;
            height: 100%;
            border: 2px solid var(--border-light);
            border-radius: 6px;
            position: relative;
            background: linear-gradient(45deg, #f0f9ff 25%, transparent 25%), linear-gradient(-45deg, #f0f9ff 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f0f9ff 75%), linear-gradient(-45deg, transparent 75%, #f0f9ff 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .resource-area {
            position: absolute;
            border: 3px solid;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

        .preference-region {
            position: absolute;
            border: 2px dashed;
            border-radius: 8px;
            opacity: 0.35;
        }

        .envy-analysis {
            background: var(--bg-white);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border: 1px solid var(--border-light);
        }

        .envy-matrix-container {
            overflow-x: auto;
            margin: 1rem 0;
        }

        .envy-matrix {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

            .envy-matrix th,
            .envy-matrix td {
                padding: 0.75rem;
                text-align: center;
                border: 1px solid var(--border-medium);
            }

            .envy-matrix th {
                background: var(--bg-light);
                font-weight: 600;
                color: var(--text-primary);
            }

            .envy-matrix .matrix-cell {
                transition: all 0.2s ease;
                font-weight: 600;
            }

                .envy-matrix .matrix-cell.envy {
                    background: linear-gradient(135deg, #fecaca, #fca5a5);
                    color: #991b1b;
                    font-weight: bold;
                }

                .envy-matrix .matrix-cell.no-envy {
                    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
                    color: #065f46;
                }

                .envy-matrix .matrix-cell.self {
                    background: var(--light-blue);
                    color: var(--primary-blue);
                    font-weight: bold;
                }

        .matrix-explanation {
            background: var(--bg-light);
            padding: 0.75rem;
            border-radius: 6px;
            border-left: 3px solid var(--primary-blue);
        }

            .matrix-explanation p {
                font-size: 0.85rem;
                color: var(--text-secondary);
                margin: 0;
            }

        .results-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .player-result-card {
            background: var(--bg-white);
            border-radius: 8px;
            padding: 1.25rem;
            border-left: 4px solid var(--primary-blue);
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }

            .player-result-card:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }

        .player-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .player-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-blue);
            font-family: 'Courier New', monospace;
            margin-bottom: 0.5rem;
        }

        .envy-status {
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.8rem;
            text-align: center;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

            .envy-status.no-envy {
                background: linear-gradient(135deg, #d1fae5, #a7f3d0);
                color: #065f46;
            }

            .envy-status.has-envy {
                background: linear-gradient(135deg, #fecaca, #fca5a5);
                color: #991b1b;
            }

        .envy-details {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .summary-container {
            background: var(--light-blue);
            padding: 1.25rem;
            border-radius: 8px;
            text-align: center;
            font-size: 0.95rem;
            color: var(--primary-blue);
            font-weight: 500;
            margin-top: 1.5rem;
        }

        @media (max-width: 768px) {
            .demo-section {
                padding: 1.5rem;
            }

            .results-container {
                grid-template-columns: 1fr;
            }

            .envy-matrix {
                font-size: 0.75rem;
            }

                .envy-matrix th,
                .envy-matrix td {
                    padding: 0.5rem;
                }
        }
    </style>
</head>
<body>
    <div class="demo-section" id="envyFreenessDemo">
        <h4>Interactive Envy-Freeness Exploration</h4>

        <div class="demo-explanation">
            <p>
                Envy occurs when a player prefers another's allocation to their own.
                Watch how changing division lines affects envy relationships between players.
            </p>
        </div>

        <div class="demo-controls">
            <div class="control-group">
                <label class="control-label">Number of Players:</label>
                <div class="slider-container">
                    <input type="range" id="envyPlayerCount" class="demo-slider" min="2" max="4" value="3">
                    <span id="envyPlayerValue" class="value-display">3</span>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Division Style:</label>
                <select id="envyDivisionType" class="demo-select">
                    <option value="vertical">Vertical Strips</option>
                    <option value="horizontal">Horizontal Strips</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Division Points:</label>
                <div id="envyDivisionControls"></div>
            </div>
        </div>

        <div class="visualization-container">
            <div id="envyVisualization"></div>
        </div>

        <div class="envy-analysis">
            <h5>Envy Matrix</h5>
            <div id="envyMatrix" class="envy-matrix-container"></div>
            <div class="matrix-explanation">
                <p>
                    Each cell shows how much Player A values Player B's piece.
                    Red cells indicate envy (prefers other's piece).
                </p>
            </div>
        </div>

        <div id="envyResults" class="results-container"></div>

        <div id="envySummary" class="summary-container">
            Adjust the controls above to explore different resource divisions and see how envy relationships change.
        </div>
    </div>

    <script>
        class EnvyFreenessVisualizer {
            constructor() {
                this.playerCount = 3;
                this.divisionType = 'vertical';
                this.divisionPoints = [];
                this.colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b'];
                this.playerNames = ['Red', 'Blue', 'Green', 'Orange'];
                this.players = [];
                this.setupPlayers();
                this.setupDivisions();
            }

            setupPlayers() {
                this.players = [];

                // Define overlapping preference patterns that create interesting envy scenarios
                const patterns = [
                    // Red: Wants top-left and center-right
                    [
                        { type: 'rect', x: 5, y: 60, width: 40, height: 35, value: 60 },
                        { type: 'ellipse', x: 50, y: 30, width: 40, height: 40, value: 40 }
                    ],
                    // Blue: Wants left side and bottom-right
                    [
                        { type: 'rect', x: 5, y: 10, width: 35, height: 80, value: 65 },
                        { type: 'ellipse', x: 60, y: 5, width: 30, height: 30, value: 35 }
                    ],
                    // Green: Wants center and right edge
                    [
                        { type: 'rect', x: 25, y: 30, width: 50, height: 40, value: 55 },
                        { type: 'rect', x: 75, y: 10, width: 20, height: 80, value: 45 }
                    ],
                    // Orange: Wants bottom strip and top corners
                    [
                        { type: 'rect', x: 10, y: 5, width: 80, height: 25, value: 50 },
                        { type: 'ellipse', x: 65, y: 70, width: 30, height: 25, value: 50 }
                    ]
                ];

                for (let i = 0; i < this.playerCount; i++) {
                    this.players.push({
                        name: this.playerNames[i],
                        color: this.colors[i],
                        regions: patterns[i]
                    });
                }
            }

            setupDivisions() {
                // Start with unequal divisions to create envy
                this.divisionPoints = [];
                if (this.divisionType === 'vertical') {
                    if (this.playerCount === 2) {
                        this.divisionPoints = [35]; // Unequal: 35 vs 65
                    } else if (this.playerCount === 3) {
                        this.divisionPoints = [25, 70]; // Very unequal: 25, 45, 30
                    } else { // 4 players
                        this.divisionPoints = [20, 45, 80]; // Unequal spacing
                    }
                } else { // horizontal
                    if (this.playerCount === 2) {
                        this.divisionPoints = [40];
                    } else if (this.playerCount === 3) {
                        this.divisionPoints = [30, 75];
                    } else { // 4 players
                        this.divisionPoints = [20, 50, 85];
                    }
                }
            }

            calculateOverlap(allocation, region) {
                if (region.type === 'rect') {
                    return this.calculateRectOverlap(allocation, region);
                } else if (region.type === 'ellipse') {
                    return this.calculateEllipseOverlap(allocation, region);
                }
                return 0;
            }

            calculateRectOverlap(rect1, rect2) {
                const left = Math.max(rect1.x, rect2.x);
                const right = Math.min(rect1.x + rect1.width, rect2.x + rect2.width);
                const top = Math.max(rect1.y, rect2.y);
                const bottom = Math.min(rect1.y + rect1.height, rect2.y + rect2.height);

                if (left < right && top < bottom) {
                    return (right - left) * (bottom - top);
                }
                return 0;
            }

            calculateEllipseOverlap(rect, ellipse) {
                // Approximate ellipse-rectangle overlap using sampling
                const cx = ellipse.x + ellipse.width / 2;
                const cy = ellipse.y + ellipse.height / 2;
                const rx = ellipse.width / 2;
                const ry = ellipse.height / 2;

                const samples = 25;
                let overlapArea = 0;
                const dx = rect.width / samples;
                const dy = rect.height / samples;

                for (let i = 0; i < samples; i++) {
                    for (let j = 0; j < samples; j++) {
                        const x = rect.x + i * dx + dx / 2;
                        const y = rect.y + j * dy + dy / 2;

                        // Check if point is inside ellipse
                        if (((x - cx) / rx) ** 2 + ((y - cy) / ry) ** 2 <= 1) {
                            overlapArea += dx * dy;
                        }
                    }
                }

                return overlapArea;
            }

            getPlayerAllocations() {
                const allocations = [];

                if (this.divisionType === 'vertical') {
                    let prevX = 0;
                    for (let i = 0; i < this.playerCount; i++) {
                        const nextX = i < this.divisionPoints.length ? this.divisionPoints[i] : 100;
                        allocations.push({
                            x: prevX, y: 0,
                            width: nextX - prevX, height: 100
                        });
                        prevX = nextX;
                    }
                } else {
                    let prevY = 0;
                    for (let i = 0; i < this.playerCount; i++) {
                        const nextY = i < this.divisionPoints.length ? this.divisionPoints[i] : 100;
                        allocations.push({
                            x: 0, y: prevY,
                            width: 100, height: nextY - prevY
                        });
                        prevY = nextY;
                    }
                }

                return allocations;
            }

            calculatePlayerValuation(playerIndex, allocationIndex) {
                const allocations = this.getPlayerAllocations();
                const allocation = allocations[allocationIndex];
                const player = this.players[playerIndex];

                const totalValue = player.regions.reduce((sum, region) => sum + region.value, 0);

                let receivedValue = 0;
                for (const region of player.regions) {
                    const regionArea = region.type === 'rect'
                        ? region.width * region.height
                        : Math.PI * (region.width / 2) * (region.height / 2);

                    const overlap = this.calculateOverlap(allocation, region);
                    const overlapRatio = regionArea > 0 ? overlap / regionArea : 0;
                    receivedValue += overlapRatio * region.value;
                }

                return totalValue > 0 ? (receivedValue / totalValue) * 100 : 0;
            }

            calculateEnvyMatrix() {
                const matrix = [];
                for (let i = 0; i < this.playerCount; i++) {
                    const row = [];
                    for (let j = 0; j < this.playerCount; j++) {
                        const value = this.calculatePlayerValuation(i, j);
                        row.push(value);
                    }
                    matrix.push(row);
                }
                return matrix;
            }

            calculateEnvyResults() {
                const matrix = this.calculateEnvyMatrix();
                const results = [];
                const envyRelationships = [];

                for (let i = 0; i < this.playerCount; i++) {
                    const ownValue = matrix[i][i];
                    let hasEnvy = false;
                    const enviesWhom = [];

                    for (let j = 0; j < this.playerCount; j++) {
                        if (i !== j) {
                            const otherValue = matrix[i][j];
                            if (otherValue > ownValue + 1) { // Small tolerance
                                hasEnvy = true;
                                enviesWhom.push(this.players[j].name);
                                envyRelationships.push({
                                    envier: this.players[i].name,
                                    envied: this.players[j].name,
                                    ownValue: ownValue,
                                    enviedValue: otherValue
                                });
                            }
                        }
                    }

                    results.push({
                        player: this.players[i].name,
                        value: ownValue,
                        hasEnvy: hasEnvy,
                        envies: enviesWhom,
                        color: this.players[i].color
                    });
                }

                return { results, envyRelationships, matrix };
            }

            createVisualization() {
                const container = document.getElementById('envyVisualization');
                container.innerHTML = '';

                const allocations = this.getPlayerAllocations();

                // Draw preference regions (behind)
                for (let i = 0; i < this.players.length; i++) {
                    const player = this.players[i];
                    for (const region of player.regions) {
                        const div = document.createElement('div');
                        div.className = 'preference-region';
                        div.style.left = region.x + '%';
                        div.style.top = region.y + '%';
                        div.style.width = region.width + '%';
                        div.style.height = region.height + '%';
                        div.style.borderColor = player.color;
                        div.style.backgroundColor = player.color;

                        if (region.type === 'ellipse') {
                            div.style.borderRadius = '50%';
                        }

                        container.appendChild(div);
                    }
                }

                // Draw player allocations
                for (let i = 0; i < this.players.length; i++) {
                    const player = this.players[i];
                    const allocation = allocations[i];

                    const div = document.createElement('div');
                    div.className = 'resource-area';
                    div.style.left = allocation.x + '%';
                    div.style.top = allocation.y + '%';
                    div.style.width = allocation.width + '%';
                    div.style.height = allocation.height + '%';
                    div.style.borderColor = player.color;
                    div.style.backgroundColor = player.color + '20';
                    div.textContent = player.name;
                    container.appendChild(div);
                }
            }

            updateResults() {
                const { results, envyRelationships, matrix } = this.calculateEnvyResults();

                // Update envy matrix
                this.updateEnvyMatrix(matrix);

                // Update individual results
                const container = document.getElementById('envyResults');
                container.innerHTML = '';

                results.forEach(result => {
                    const card = document.createElement('div');
                    card.className = 'player-result-card';
                    card.style.borderLeftColor = result.color;

                    const envyText = result.hasEnvy
                        ? `Envies: ${result.envies.join(', ')}`
                        : 'No envy detected';

                    card.innerHTML = `
                            <div class="player-name">${result.player}</div>
                            <div class="player-value">Values own piece: ${result.value.toFixed(1)}%</div>
                            <div class="envy-status ${result.hasEnvy ? 'has-envy' : 'no-envy'}">
                                ${result.hasEnvy ? '😔 Has Envy' : '😊 Envy-Free'}
                            </div>
                            <div class="envy-details">${envyText}</div>
                        `;

                    container.appendChild(card);
                });

                // Update summary
                const envyFreeCount = results.filter(r => !r.hasEnvy).length;
                const summary = document.getElementById('envySummary');

                if (envyFreeCount === results.length) {
                    summary.innerHTML = `🎉 <strong>Envy-Free!</strong> All ${results.length} players are satisfied with their allocations. Nobody prefers someone else's piece.`;
                } else {
                    const envyCount = results.length - envyFreeCount;
                    summary.innerHTML = `😔 <strong>Envy Present:</strong> ${envyCount} out of ${results.length} players experience envy. Total envy relationships: ${envyRelationships.length}.`;
                }
            }

            updateEnvyMatrix(matrix) {
                const container = document.getElementById('envyMatrix');

                const table = document.createElement('table');
                table.className = 'envy-matrix';

                // Header row
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = '<th>Player</th>';
                for (let i = 0; i < this.playerCount; i++) {
                    headerRow.innerHTML += `<th>${this.players[i].name}'s Piece</th>`;
                }
                table.appendChild(headerRow);

                // Data rows
                for (let i = 0; i < this.playerCount; i++) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<th>${this.players[i].name}</th>`;

                    for (let j = 0; j < this.playerCount; j++) {
                        const cell = document.createElement('td');
                        const value = matrix[i][j];
                        cell.textContent = value.toFixed(1) + '%';
                        cell.className = 'matrix-cell';

                        if (i === j) {
                            cell.classList.add('self');
                        } else if (value > matrix[i][i] + 1) {
                            cell.classList.add('envy');
                        } else {
                            cell.classList.add('no-envy');
                        }

                        row.appendChild(cell);
                    }
                    table.appendChild(row);
                }

                container.innerHTML = '';
                container.appendChild(table);
            }

            update() {
                this.createVisualization();
                this.updateResults();
            }
        }

        // Global visualizer instance
        const envyViz = new EnvyFreenessVisualizer();

        // Control handlers
        function updateEnvyDivisionControls() {
            const container = document.getElementById('envyDivisionControls');
            container.innerHTML = '';

            const numControls = envyViz.playerCount - 1;
            for (let i = 0; i < numControls; i++) {
                const div = document.createElement('div');
                div.className = 'slider-container';

                if (!envyViz.divisionPoints[i]) {
                    envyViz.setupDivisions();
                }

                div.innerHTML = `
                        <label style="min-width: 80px; font-size: 0.9rem; color: var(--text-secondary);">
                            ${envyViz.divisionType === 'vertical' ? 'Vertical' : 'Horizontal'} ${i + 1}:
                        </label>
                        <input type="range" class="demo-slider" min="5" max="95" step="1"
                               value="${envyViz.divisionPoints[i]}"
                               oninput="updateEnvyDivisionPoint(${i}, this.value)">
                        <span class="value-display">${envyViz.divisionPoints[i].toFixed(0)}%</span>
                    `;
                container.appendChild(div);
            }
        }

        function updateEnvyDivisionPoint(index, value) {
            envyViz.divisionPoints[index] = parseFloat(value);
            updateEnvyDivisionControls();
            envyViz.update();
        }

        // Event listeners
        document.getElementById('envyPlayerCount').addEventListener('input', function () {
            envyViz.playerCount = parseInt(this.value);
            document.getElementById('envyPlayerValue').textContent = envyViz.playerCount;

            envyViz.setupPlayers();
            envyViz.setupDivisions();
            updateEnvyDivisionControls();
            envyViz.update();
        });

        document.getElementById('envyDivisionType').addEventListener('change', function () {
            envyViz.divisionType = this.value;
            envyViz.setupDivisions();
            updateEnvyDivisionControls();
            envyViz.update();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            updateEnvyDivisionControls();
            envyViz.update();
        });
    </script>
</body>
</html>